<!doctype html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <title>–ê–ø—Ç–µ–∫–∞</title>

    <!-- –û–ë–©–ò–ï –°–¢–ò–õ–ò -->
    <link rel="stylesheet" href="{{ url_for('static', filename='rgz.css') }}">

    <script>
        let offset = 0;

        function search(reset = false) {
            const result = document.getElementById('result');
            const loadMoreBtn = document.getElementById('loadMoreBtn');

            if (reset) {
                offset = 0;
                result.innerHTML = '';
            }

            const name = document.getElementById('name').value;
            const prescription = document.getElementById('prescription').value;

            fetch(`/RGZ/api/medicines?name=${name}&prescription_only=${prescription}&offset=${offset}`)
                .then(r => r.json())
                .then(data => {

                    if (data.length === 0 && offset === 0) {
                        result.innerHTML = '<p>–ù–∏—á–µ–≥–æ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ</p>';
                        loadMoreBtn.style.display = 'none';
                        return;
                    }

                    data.forEach(m => {
                        result.innerHTML += `
                            <div class="card">
                                <b>${m.name}</b><br>
                                –ù–µ–ø–∞—Ç–µ–Ω—Ç–æ–≤–∞–Ω–Ω–æ–µ: ${m.generic_name}<br>
                                –ü–æ —Ä–µ—Ü–µ–ø—Ç—É: ${m.prescription_only ? '–¥–∞' : '–Ω–µ—Ç'}<br>
                                –¶–µ–Ω–∞: ${m.price} ‚ÇΩ<br>
                                –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ: ${m.quantity}<br><br>

                                {% if session.get('login') %}
                                    <button class="secondary" onclick="toggleFavorite(${m.id})">
                                        ‚ù§Ô∏è –í –∏–∑–±—Ä–∞–Ω–Ω–æ–µ
                                    </button>
                                {% endif %}
                            </div>
                        `;
                    });

                    offset += data.length;

                    // –µ—Å–ª–∏ –µ—Å—Ç—å –µ—â—ë –¥–∞–Ω–Ω—ã–µ ‚Äî –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –∫–Ω–æ–ø–∫—É
                    if (data.length === 10) {
                        loadMoreBtn.style.display = 'inline-block';
                    } else {
                        loadMoreBtn.style.display = 'none';
                    }
                });
        }

        function toggleFavorite(id) {
            fetch(`/RGZ/api/favorites/${id}`, { method: 'POST' })
                .then(() => loadFavorites());
        }

        function deleteAccount() {
            if (!confirm('–í—ã —É–≤–µ—Ä–µ–Ω—ã? –ê–∫–∫–∞—É–Ω—Ç –±—É–¥–µ—Ç —É–¥–∞–ª—ë–Ω –±–µ–∑ –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏—è.')) {
                return;
            }

            fetch('/RGZ/api/delete_account', { method: 'POST' })
                .then(() => {
                    alert('–ê–∫–∫–∞—É–Ω—Ç —É–¥–∞–ª—ë–Ω');
                    window.location.href = '/RGZ/';
                });
        }

        function loadFavorites() {
            fetch('/RGZ/api/favorites')
                .then(r => r.json())
                .then(data => {
                    if (!data || data.length === 0) {
                        document.getElementById('favorites').innerHTML =
                            '<p>–ò–∑–±—Ä–∞–Ω–Ω–æ–µ –ø—É—Å—Ç–æ</p>';
                        return;
                    }

                    let html = '';
                    data.forEach(m => {
                        html += `
                            <div class="card">
                                <b>${m.name}</b><br>
                                –¶–µ–Ω–∞: ${m.price} ‚ÇΩ<br>
                                <button class="danger" onclick="toggleFavorite(${m.id})">
                                    ‚ùå –£–±—Ä–∞—Ç—å –∏–∑ –∏–∑–±—Ä–∞–Ω–Ω–æ–≥–æ
                                </button>
                            </div>
                        `;
                    });

                    document.getElementById('favorites').innerHTML = html;
                });
        }

        // üî• –í–ê–ñ–ù–û: –ø—Ä–∏ –∑–∞—Ö–æ–¥–µ –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü—É —Å—Ä–∞–∑—É –≥—Ä—É–∑–∏–º –ø–µ—Ä–≤—ã–µ 10
        document.addEventListener('DOMContentLoaded', () => {
            search(true);
            {% if session.get('login') %}
                loadFavorites();
            {% endif %}
        });
    </script>
</head>

<body>

<!-- ===== –•–ï–î–ï–† ===== -->
<header>
    <h1>–ê–ø—Ç–µ–∫–∞ ¬´–ó–¥–æ—Ä–æ–≤—å–µ+¬ª</h1>

    <nav>
        <a href="/RGZ/">–ì–ª–∞–≤–Ω–∞—è</a>

        {% if session.get('login') %}
            {% if session.get('is_admin') %}
                <a href="/RGZ/admin/">–ê–¥–º–∏–Ω-–ø–∞–Ω–µ–ª—å</a>
            {% endif %}
            <a href="/RGZ/logout/">–í—ã–π—Ç–∏</a>
        {% else %}
            <a href="/RGZ/login/">–í—Ö–æ–¥</a>
            <a href="/RGZ/register/">–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è</a>
        {% endif %}
    </nav>

    {% if session.get('login') %}
        <div class="user-info">
            <span>
                –í—ã –≤–æ—à–ª–∏ –∫–∞–∫ <b>{{ session.get('login') }}</b>
            </span>
            <button class="danger" onclick="deleteAccount()">
                –£–¥–∞–ª–∏—Ç—å –∞–∫–∫–∞—É–Ω—Ç
            </button>
        </div>
    {% endif %}
</header>

<!-- ===== –û–°–ù–û–í–ù–û–ô –ö–û–ù–¢–ï–ù–¢ ===== -->
<main>

{% if session.get('login') %}
<h3>–ú–æ—ë –∏–∑–±—Ä–∞–Ω–Ω–æ–µ</h3>
<div id="favorites">
    <p>–ó–∞–≥—Ä—É–∑–∫–∞...</p>
</div>
<button class="secondary" onclick="loadFavorites()">–û–±–Ω–æ–≤–∏—Ç—å –∏–∑–±—Ä–∞–Ω–Ω–æ–µ</button>
<hr>
{% endif %}

<h3>–ü–æ–∏—Å–∫ –ª–µ–∫–∞—Ä—Å—Ç–≤</h3>

<form onsubmit="event.preventDefault(); search(true);">
    –ù–∞–∑–≤–∞–Ω–∏–µ:
    <input type="text" id="name">

    –ü–æ —Ä–µ—Ü–µ–ø—Ç—É:
    <select id="prescription">
        <option value="">–ª—é–±—ã–µ</option>
        <option value="1">–¥–∞</option>
        <option value="0">–Ω–µ—Ç</option>
    </select>

    <button class="primary" type="submit">–ü–æ–∏—Å–∫</button>
</form>

<hr>

<div id="result"></div>

<button
    id="loadMoreBtn"
    class="primary"
    style="display:none"
    onclick="search()"
>
    –ü–æ–∫–∞–∑–∞—Ç—å –µ—â—ë
</button>

</main>

<!-- ===== –§–£–¢–ï–† ===== -->
<footer>
    –ß–∏–Ω–∫–µ–≤–∏—á –ö–∏—Ä–∏–ª–ª –ê–ª–µ–∫—Å–µ–µ–≤–∏—á, –§–ë–ò-32
</footer>

</body>
</html>
