{% extends "base.html" %}

{% block main %}
<style>
.field {
  position: relative;
  width: 1000px;
  height: 500px;
  margin-top: 20px;
  overflow: visible;
}

.gift {
  position: absolute;
  max-width: 120px;
  height: auto;
  cursor: pointer;
  transition: transform 0.2s, opacity 0.2s;
}

.gift:hover {
  transform: scale(1.1);
  z-index: 2;
}

.gift.empty {
  opacity: 0.4;
  filter: grayscale(1);
  pointer-events: none;
}

/* –ú–û–î–ê–õ–ö–ê */
.modal {
  display: none;
  position: fixed;
  inset: 0;
  background: rgba(0,0,0,0.6);
  z-index: 1000;
}

.modal-content {
  background: #fff;
  width: 360px;
  padding: 20px;
  border-radius: 16px;
  position: absolute;
  top: 50%;
  left: 50%;
  transform: translate(-50%, -50%);
  text-align: center;
}

.modal-content img {
  max-width: 200px;
}

.close {
  position: absolute;
  top: 8px;
  right: 12px;
  font-size: 24px;
  cursor: pointer;
}

.santa-btn {
  margin-top: 12px;
  padding: 8px 16px;

  background: #d32f2f;
  color: white;

  border: none;
  border-radius: 6px;

  font-size: 15px;
  cursor: pointer;
}

.santa-btn:hover {
  background: #b71c1c;
}
</style>

<h1>üéÑ –ù–æ–≤–æ–≥–æ–¥–Ω–∏–µ –ø–æ–¥–∞—Ä–∫–∏ üéÑ</h1>

<p>
  –ù–µ–æ—Ç–∫—Ä—ã—Ç—ã—Ö –∫–æ—Ä–æ–±–æ–∫:
  <strong><span id="counter">{{ unopened }}</span></strong>
</p>

{% if session.get('login') %}
  <button class="santa-btn" onclick="resetAll()">üéÖ –î–µ–¥ –ú–æ—Ä–æ–∑</button>
{% endif %}

<div class="field">
  {% for id, pos in positions.items() %}
    <img
      src="/static/lab9/gift{{ id }}.png"
      class="gift {% if id in opened_ids %}empty{% endif %}"
      style="top: {{ pos.top }}px; left: {{ pos.left }}px;"
      onclick="openGift({{ id }}, this)"
    >
  {% endfor %}
</div>

<div id="modal" class="modal">
  <div class="modal-content">
    <span class="close" onclick="closeModal()">√ó</span>
    <img id="modal-img">
    <p id="modal-text"></p>
  </div>
</div>
{% endblock %}

{% block script %}
<script>
let currentGift = null;

function openGift(id, el) {
    fetch('/lab9/open', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({ box_id: id })
    })
    .then(r => r.json())
    .then(data => {
        if (data.error) {
            alert(data.error);
            return;
        }

        currentGift = el;

        document.getElementById('modal-img').src =
            `/static/lab9/present${id}.png`;
        document.getElementById('modal-text').innerText = data.message;
        document.getElementById('modal').style.display = 'block';

        document.getElementById('counter').innerText--;
    });
}

function closeModal() {
    document.getElementById('modal').style.display = 'none';
    if (currentGift) {
        currentGift.classList.add('empty');
        currentGift = null;
    }
}

function resetAll() {
    fetch('/lab9/reset_all', { method: 'POST' })
        .then(() => location.reload());
}

window.onclick = function(e) {
    if (e.target === document.getElementById('modal')) {
        closeModal();
    }
}
</script>
{% endblock %}
