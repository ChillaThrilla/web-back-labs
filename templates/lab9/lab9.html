{% extends "base.html" %}

{% block main %}
<style>
/* ===== –ü–û–õ–ï –° –ö–û–†–û–ë–ö–ê–ú–ò ===== */
.field {
  position: relative;
  width: 1000px;
  height: 500px;
  margin-top: 20px;
  overflow: visible;
}

/* ===== –ö–û–†–û–ë–ö–ò ===== */
.gift {
  position: absolute;
  max-width: 120px;
  height: auto;

  cursor: pointer;
  user-select: none;

  transition: transform 0.2s ease, opacity 0.2s ease;
}

.gift:hover {
  transform: scale(1.1);
  z-index: 2;
}

.gift.empty {
  opacity: 0.4;
  filter: grayscale(1);
  pointer-events: none;
}

/* ===== –ú–û–î–ê–õ–¨–ù–û–ï –û–ö–ù–û ===== */
.modal {
  display: none;
  position: fixed;
  z-index: 1000;

  top: 0;
  left: 0;
  width: 100%;
  height: 100%;

  background: rgba(0, 0, 0, 0.6);
}

.modal-content {
  background: #ffffff;
  width: 360px;
  padding: 20px;
  border-radius: 16px;

  position: absolute;
  top: 50%;
  left: 50%;
  transform: translate(-50%, -50%);

  text-align: center;
}

.modal-content img {
  max-width: 200px;
  height: auto;
  margin-bottom: 12px;
}

.modal-content p {
  font-size: 18px;
}

.close {
  position: absolute;
  top: 8px;
  right: 12px;
  font-size: 24px;
  cursor: pointer;
}

/* ===== –¢–ï–ö–°–¢ ===== */
#result {
  margin-top: 20px;
  font-size: 18px;
}
</style>

<h1>üéÑ –ù–æ–≤–æ–≥–æ–¥–Ω–∏–µ –ø–æ–¥–∞—Ä–∫–∏ üéÑ</h1>

<p>
  –ù–µ–æ—Ç–∫—Ä—ã—Ç—ã—Ö –∫–æ—Ä–æ–±–æ–∫:
  <strong><span id="counter">{{ unopened }}</span></strong>
</p>

<!-- –ü–û–õ–ï –° –ö–û–†–û–ë–ö–ê–ú–ò -->
<div class="field">
  {% for id, pos in positions.items() %}
    <img
    src="/static/lab9/gift{{ id }}.png"
    class="gift {% if id in opened_ids %}empty{% endif %}"
    style="top: {{ pos.top }}px; left: {{ pos.left }}px;"
    onclick="openGift({{ id }}, this)"
    >
  {% endfor %}
</div>

<!-- –ú–û–î–ê–õ–¨–ù–û–ï –û–ö–ù–û -->
<div id="modal" class="modal">
  <div class="modal-content">
    <span class="close" onclick="closeModal()">√ó</span>
    <img id="modal-img" src="" alt="–ü–æ–¥–∞—Ä–æ–∫">
    <p id="modal-text"></p>
  </div>
</div>

{% endblock %}

{% block script %}
<script>
function openGift(id, el) {
    fetch('/lab9/open', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({ box_id: id })
    })
    .then(r => r.json())
    .then(data => {
        if (data.error) {
            alert(data.error);
            return;
        }

        // –ø–æ–º–µ—á–∞–µ–º –∫–æ—Ä–æ–±–∫—É –ø—É—Å—Ç–æ–π
        el.classList.add('empty');

        // –ö–ê–†–¢–ò–ù–ö–ê –ü–û–î–ê–†–ö–ê (–ü–û –ò–ù–î–ï–ö–°–£)
        document.getElementById('modal-img').src =
            `/static/lab9/present${id}.png`;

        // –ø–æ–∑–¥—Ä–∞–≤–ª–µ–Ω–∏–µ
        document.getElementById('modal-text').innerText = data.message;

        // –ø–æ–∫–∞–∑–∞—Ç—å –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ
        document.getElementById('modal').style.display = 'block';

        // —É–º–µ–Ω—å—à–∏—Ç—å —Å—á—ë—Ç—á–∏–∫
        document.getElementById('counter').innerText--;
    });
}

function closeModal() {
    document.getElementById('modal').style.display = 'none';
}

// –∑–∞–∫—Ä—ã—Ç–∏–µ –ø–æ –∫–ª–∏–∫—É –≤–Ω–µ –æ–∫–Ω–∞
window.onclick = function(e) {
    const modal = document.getElementById('modal');
    if (e.target === modal) {
        modal.style.display = 'none';
    }
}
</script>
{% endblock %}
